#!/bin/bash

trap "exit 130" SIGINT
trap "exit 137" SIGKILL
trap "exit 143" SIGTERM

source {{ sysconfig_dir }}/hpfeeds-cif
export $PYTHONPATH



cd {{ hpfeeds_cif_dir }}
if [[ ! -f ./hpfeeds-cif.cfg ]]
then
    IDENT='hpfeeds-cif'
    SECRET=`python -c 'import uuid;print str(uuid.uuid4()).replace("-","")'`
    CHANNELS='amun.events,conpot.events,thug.events,beeswarm.hive,dionaea.capture,dionaea.connections,thug.files,beeswarn.feeder,cuckoo.analysis,kippo.sessions,cowrie.sessions,glastopf.events,glastopf.files,mwbinary.dionaea.sensorunique,snort.alerts,wordpot.events,p0f.events,suricata.events,shockpot.events,elastichoney.events'

    cp ./hpfeeds-cif.cfg.template ./hpfeeds-cif.cfg

    sed -i "s/ident *=.*/ident = $IDENT/g" {{ hpfeeds_cif_dir }}/hpfeeds-cif.cfg
    sed -i "s/secret *=.*/secret = $SECRET/g" {{ hpfeeds_cif_dir }}/hpfeeds-cif.cfg
    sed -i "s/hp_host *=.*/hp_host = ${HPFEEDS_HOST}/g" {{ hpfeeds_cif_dir }}/hpfeeds-cif.cfg
    sed -i "s/hp_port *=.*/hp_port = ${HPFEEDS_PORT}/g" {{ hpfeeds_cif_dir }}/hpfeeds-cif.cfg
    sed -i "s/channels *=.*/channels = $CHANNELS/g" {{ hpfeeds_cif_dir }}/hpfeeds-cif.cfg
    sed -i "s/cif_host =.*cif_host = ${CIF_HOST}/g" {{ hpfeeds_cif_dir }}/hpfeeds-cif.cfg
    sed -i "s/cif_token *=.*/cif_token = ${CIF_TOKEN}/g" {{ hpfeeds_cif_dir }}/hpfeeds-cif.cfg
    sed -i "s/cif_provider *=.*/cif_provider = ${CIF_PROVIDER}/g" {{ hpfeeds_cif_dir }}/hpfeeds-cif.cfg
    sed -i "s/cif_tlp *=.*/cif_tlp = ${CIF_TLP}/g" {{ hpfeeds_cif_dir }}/hpfeeds-cif.cfg
    sed -i "s/cif_confidence *=.*/cif_confidence = ${CIF_CONFIDENCE}/g" {{ hpfeeds_cif_dir }}/hpfeeds-cif.cfg
    sed -i "s/cif_tags *=.*/cif_tags = ${CIF_TAGS}/g" {{ hpfeeds_cif_dir }}/hpfeeds-cif.cfg
    sed -i "s/cif_group *=.*/cif_group = ${CIF_GROUP}/g" {{ hpfeeds_cif_dir }}/hpfeeds-cif.cfg
    sed -i "s/cif_verify_ssl *=.*/cif_verify_ssl = ${CIF_VERIFY_SSL}/g" {{ hpfeeds_cif_dir }}/hpfeeds-cif.cfg

    # Generate config file for hpfeeds broker and register
    cd {{ hpfeeds_dir }}/hpfeeds/broker/
    python {{ hpfeeds_dir }}/hpfeeds/broker/generateconfig.py unattended --mongo_host ${MONGODB_HOST} --mongo_port ${MONGODB_PORT}
    python {{ hpfeeds_dir }}/hpfeeds/broker/add_user.py "$IDENT" "$SECRET" "" "$CHANNELS"
fi

cd {{ hpfeeds_cif_dir }}
echo "Starting hpfeeds cif..."

exec /usr/bin/env python {{ hpfeeds_cif_dir }}/hpfeeds-cif/feedhandler.py {{ hpfeeds_cif_dir }}/hpfeeds-cif.cfg
